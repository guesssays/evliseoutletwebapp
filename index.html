<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>EVLISE OUTLET — интернет-магазин одежды</title>
  <meta name="description" content="EVLISE OUTLET — стильная женская и мужская одежда со скидками. Новинки, акции и быстрый заказ прямо в Telegram WebApp." />
  <meta name="theme-color" content="#121111" />
  <meta name="application-name" content="EVLISE OUTLET" />
  <meta name="apple-mobile-web-app-title" content="EVLISE OUTLET" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Анти-кэш для HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Favicon / icons -->
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="EVLISE OUTLET" />
  <meta property="og:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta property="og:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta property="og:locale" content="ru_RU" />
  <meta property="og:image" content="assets/images/og-evlise.png" />
  <meta property="og:image:alt" content="EVLISE OUTLET — баннер магазина" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta name="twitter:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta name="twitter:image" content="assets/images/og-evlise.png" />

  <!-- Fonts / styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=2025-10-28-15-06" />

  <style>
    /* --------- БАЗОВЫЕ ПЕРЕМЕННЫЕ (если нет в styles.css) --------- */
    :root{
      --safe: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --stroke: rgba(15,23,42,.14);
      --tabbar-h: 64px;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
    }

    /* Скрытие/появление штатного верхнего хедера */
    .app-header.hidden{
      transform: translateY(-100%);
      opacity: 0;
      pointer-events: none;
      transition: transform .18s ease, opacity .18s ease;
    }

    /* --------- ФИКС-ХЕДЕР ТОВАРА (визуал) --------- */
    .product-fixhdr{
      position: fixed;
      left: 0; right: 0;
      top: calc(var(--safe-top) + 8px);
      height: 56px;
      display: none;               /* скрыт по умолчанию */
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      pointer-events: none;        /* кликабельны только кнопки */
      /* z-index задаётся в styles.css единожды */
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    .product-fixhdr.show{
      display: flex;               /* показывается при .show */
    }
    .product-fixhdr .fixbtn{
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      backdrop-filter: saturate(1.3) blur(8px);
      -webkit-backdrop-filter: saturate(1.3) blur(8px);
      box-shadow: var(--shadow);
      color: #111;
    }
    @media (prefers-color-scheme:dark){
      .product-fixhdr .fixbtn{
        background: rgba(11,18,32,.7);
        color: #fff;
      }
    }
    #btnFixBack{ margin-left: 8px; }
    #btnFixFav{ margin-right: 8px; }
    #btnFixFav.active .lucide-heart{ color:#ff4d5a; fill:currentColor; stroke:none; }

    /* --------- КНОПКА «НАВЕРХ» (визуал) --------- */
    #scrollTopBtn{
      position: fixed;
      right: 16px;
      bottom: calc(var(--tabbar-h) + var(--safe) + 16px);
      /* z-index задаётся в styles.css единожды */
      width: 48px; height: 48px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: #fff;
      box-shadow: var(--shadow);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    #scrollTopBtn[hidden]{ display: none !important; }
    @media (prefers-color-scheme:dark){
      #scrollTopBtn{ background:#0b1220; color:#fff; }
    }

    /* === Поиск с иконкой камеры === */
    .section-search .search-wrap{
      position: relative;
    }
    .section-search .search{
      width: 100%;
      padding-right: 44px;         /* место под кнопку камеры */
    }
    .search-photo{
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }
    @media (prefers-color-scheme:dark){
      .search-photo{ background:#0b1220; color:#fff; }
    }
    .search-photo i{ pointer-events:none; }
  </style>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Lucide (пинованная версия) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.454.0/dist/umd/lucide.min.js" defer></script>
</head>

<body>
  <div id="app">
    <!-- Статичный хедер -->
    <header class="app-header" role="banner">
      <div class="hdr-left">
        <div class="brand">
          <span class="app-title" aria-label="EVLISE OUTLET">EVLISE OUTLET</span>
        </div>
      </div>
      <div class="hdr-right">
        <button
          id="openNotifications"
          class="icon-btn notif-btn"
          aria-label="Уведомления"
          aria-live="polite"
          aria-atomic="true">
          <i data-lucide="bell"></i>
          <b id="notifBadge" class="badge" hidden>0</b>
        </button>
      </div>
    </header>

    <!-- Фикс-хедер товара (разметка; поведение в ProductFixHeader.js) -->
    <div id="productFixHdr" class="product-fixhdr" aria-hidden="true">
      <button id="btnFixBack" class="fixbtn" aria-label="Назад">
        <i data-lucide="arrow-left"></i>
      </button>
      <button id="btnFixFav" class="fixbtn" aria-label="В избранное" aria-pressed="false">
        <i data-lucide="heart"></i>
      </button>
    </div>

    <!-- Поиск + фильтры -->
    <section class="section section-search">
      <div class="search-wrap">
        <i data-lucide="search" class="search-ico"></i>
        <input id="searchInput" class="search" placeholder="Поиск одежды…" />
        <!-- Новое: кнопка камеры -->
        <button id="btnPhotoSearch" class="search-photo" aria-label="Поиск по фото">
          <i data-lucide="camera"></i>
        </button>
      </div>
      <button id="openFilters" class="square-btn" aria-label="Открыть фильтры">
        <i data-lucide="sliders-horizontal"></i>
      </button>
    </section>

    <!-- Категории -->
    <section class="section">
      <div class="chipbar" id="catChips" aria-label="Категории"></div>
    </section>

    <!-- Активные фильтры -->
    <section class="section" id="activeFilters" aria-live="polite"></section>

    <!-- Контент -->
    <main id="view" class="view"></main>

    <!-- Модалка -->
    <div id="modal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true">
        <div class="modal-head">
          <div id="modalTitle"></div>
          <button id="modalClose" class="icon-btn" aria-label="Закрыть"><i data-lucide="x"></i></button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div id="modalActions" class="modal-actions"></div>
      </div>
    </div>

    <div id="toastWrap" class="toast-wrap"></div>

    <!-- Нижний таббар -->
    <nav class="tabbar" role="tablist" aria-label="Основная навигация">
      <div class="tabbar-inner">
        <a href="#/" data-tab="home" class="tab active" role="tab" aria-selected="true">
          <i data-lucide="home"></i><span>Главная</span>
        </a>
        <a href="#/favorites" data-tab="saved" class="tab" role="tab" aria-selected="false">
          <i data-lucide="heart"></i><span>Избранное</span>
        </a>
        <a href="#/cart" data-tab="cart" class="tab badge-wrap" role="tab" aria-selected="false">
          <i data-lucide="shopping-bag"></i><span>Корзина</span>
          <b id="cartBadge" class="badge" hidden></b>
        </a>
        <a href="#/account" data-tab="account" class="tab" role="tab" aria-selected="false">
          <i data-lucide="user-round"></i><span>Аккаунт</span>
        </a>
      </div>
    </nav>

    <!-- Кнопка «вверх» (разметка; поведение в ScrollTop.js) -->
    <button id="scrollTopBtn" class="icon-btn" aria-label="Наверх" hidden>
      <i data-lucide="chevrons-up"></i>
    </button>

    <!-- Шаблоны -->
    <template id="product-card">
      <a class="card" href="#">
        <div class="card-img">
          <img loading="lazy" alt="">
          <button class="fav" aria-label="В избранное" aria-pressed="false">
            <i data-lucide="heart"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="title"></div>
          <div class="subtitle"></div>
          <div class="price-row">
            <div class="price"></div>
          </div>
        </div>
      </a>
    </template>

    <template id="filter-chip">
      <span class="chip chip-mini"></span>
    </template>
  </div>

  <!-- === ADMIN TOKEN INJECTION (works in Telegram WebApp only) === -->
  <script>
    (function () {
      // !!! ЗАМЕНИ на точное значение ADMIN_API_TOKEN из Netlify !!!
      var ADMIN_TOKEN = 'UsA^5976JJbD4g6j*t^jkJMoMa%*Ho!j';

      var h = (document.referrer || '').toLowerCase();
      var ua = (navigator.userAgent || '').toLowerCase();
      var isTgRef = h.startsWith('https://t.me') ||
                    h.startsWith('https://web.telegram.org') ||
                    h.startsWith('https://telegram.org');
      var isTgUA  = ua.indexOf('telegram') !== -1;

      var hasInitData = (function () {
        try { return typeof window.Telegram?.WebApp?.initData === 'string' && window.Telegram.WebApp.initData.length > 0; }
        catch { return false; }
      })();

      if ((isTgRef || isTgUA || hasInitData) && ADMIN_TOKEN) {
        window.__ADMIN_API_TOKEN__ = ADMIN_TOKEN;
        try { localStorage.setItem('admin_api_token', String(ADMIN_TOKEN)); } catch {}
      }

      try {
        var p = new URLSearchParams(location.search);
        var q = p.get('admintoken');
        if (q) {
          window.__ADMIN_API_TOKEN__ = q;
          localStorage.setItem('admin_api_token', q);
          p.delete('admintoken');
          history.replaceState({}, '', location.pathname + (p.toString() ? '?' + p.toString() : '') + location.hash);
        }
      } catch {}
    })();
  </script>

  <!-- === Поиск по фото: модалка и переход к оператору === -->
  <script>
    (function(){
      // username без @
      var SUPPORT_TARGET = 'evliseorder';

      function tgOpen(url){
        try {
          if (window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.openTelegramLink === 'function'){
            Telegram.WebApp.openTelegramLink(url);
            return;
          }
        } catch {}
        window.open(url, '_blank', 'noopener,noreferrer');
      }

      function resolveTargetLink(){
        if (!SUPPORT_TARGET) return 'https://t.me/';
        if (/^https?:\/\//i.test(SUPPORT_TARGET)) return SUPPORT_TARGET;
        return 'https://t.me/' + SUPPORT_TARGET;
      }

      function openPhotoSearchModal(){
        var modal = document.getElementById('modal');
        var mb = document.getElementById('modalBody');
        var mt = document.getElementById('modalTitle');
        var ma = document.getElementById('modalActions');
        if (!modal || !mb || !mt || !ma) return;

        mt.textContent = 'Поиск по фото';
        mb.innerHTML = `
          <div class="muted" style="margin-bottom:12px">
            Отправьте нам фото желаемой вещи — оператор подберёт варианты и пришлёт ссылки.
          </div>
          <ul class="mini" style="margin:0 0 12px 18px; line-height:1.4">
            <li>Прикрепите 1–5 фото (желательно на белом фоне или на модели)</li>
            <li>Напишите параметры: размер, цвет, бюджет</li>
            <li>Мы ответим прямо в чате</li>
          </ul>
          <div class="muted mini">Поддерживаются изображения и PDF (чеки/референсы).</div>
        `;
        var link = resolveTargetLink();
        ma.innerHTML = `
          <button id="psCancel" class="pill">Отмена</button>
          <button id="psOpenChat" class="pill primary">
            <i data-lucide="send"></i><span style="margin-left:6px">Написать оператору</span>
          </button>
        `;

        modal.classList.add('show');
        try { window.lucide?.createIcons?.(); } catch {}

        var close = function(){ modal.classList.remove('show'); };
        document.getElementById('modalClose')?.addEventListener('click', close, { once:true });
        document.getElementById('psCancel')?.addEventListener('click', close, { once:true });
        document.getElementById('psOpenChat')?.addEventListener('click', function(){
          tgOpen(link);
          close();
        }, { once:true });

        // Esc закрывает
        var onKey = function(e){ if (e.key==='Escape'){ close(); window.removeEventListener('keydown', onKey);} };
        window.addEventListener('keydown', onKey);
      }

      // Кнопка в поиске
      document.getElementById('btnPhotoSearch')?.addEventListener('click', function(e){
        e.preventDefault();
        openPhotoSearchModal();
      });

      // На всякий: иконки после монтирования
      try { window.lucide?.createIcons?.(); } catch {}
    })();
  </script>

  <!-- Главный модуль -->
  <script type="module" src="src/main.js?v=2025-10-28-15-06"></script>

  <!-- Иконки после монтирования (запасной вызов) -->
  <script> try { window.lucide?.createIcons?.(); } catch {} </script>
</body>
</html>
