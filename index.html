<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />

  <!-- ▼ Maintenance gate (must be before your main scripts) -->
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --m-bg:#ffffff; --m-text:#121111; --m-muted:#787676; --m-card:#f6f6f6; --m-border:#ececec; --m-primary:#121111;
    }
    .tg-dark, [data-theme="dark"]{
      --m-bg:#0f0f0f; --m-text:#f5f5f5; --m-muted:#a3a1a2; --m-card:#161616; --m-border:#262626; --m-primary:#f5f5f5;
    }
    #maintenanceScreen{
      position:fixed; inset:0; z-index:999999;
      display:none; align-items:center; justify-content:center; text-align:center;
      background:var(--m-bg); color:var(--m-text);
      padding:28px;
      font-family:"Encode Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
    }
    #maintenanceScreen.show{ display:flex; }
    .m-card{
      width:min(560px, 100%);
      border:1px solid var(--m-border);
      background:var(--m-card);
      border-radius:22px;
      box-shadow:0 12px 30px rgba(0,0,0,.10);
      padding:26px 22px;
    }
    .m-hero{
      width:64px; height:64px; margin:0 auto 14px; border-radius:18px;
      display:grid; place-items:center;
      background:rgba(0,0,0,.06); border:1px solid var(--m-border);
    }
    .tg-dark .m-hero, [data-theme="dark"] .m-hero{ background:rgba(255,255,255,.05); }
    .m-hero i{ width:28px; height:28px; } /* Lucide target */
    .m-title{ font-size:22px; font-weight:800; letter-spacing:.2px; }
    .m-sub{ color:var(--m-muted); margin-top:8px; line-height:1.35; font-size:15px; }
    .m-cta{ margin-top:18px; display:flex; justify-content:center; }
    .m-btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:12px 16px; border-radius:999px;
      border:1px solid var(--m-primary); background:var(--m-primary); color:var(--m-bg);
      font-weight:700; cursor:pointer;
    }
    .m-btn i{ width:18px; height:18px; }
    .m-note{ margin-top:12px; font-size:.92rem; color:var(--m-muted); }
    html.maintenance-lock, body.maintenance-lock{ overflow:hidden !important; }
  </style>

  <div id="maintenanceScreen" role="dialog" aria-modal="true" aria-live="polite" aria-label="Технические работы">
    <div class="m-card">
      <div class="m-hero" aria-hidden="true">
        <!-- Lucide icon from library -->
        <i data-lucide="hard-hat"></i>
      </div>
      <div class="m-title">Технические работы</div>
      <div class="m-sub">
        Мы обновляем приложение и улучшаем сервис.<br/>
        По заказу или другим вопросам — напишите оператору.
      </div>
      <div class="m-cta">
        <button id="mOpBtn" class="m-btn" type="button" aria-label="Написать оператору">
          <i data-lucide="send"></i><span>Написать оператору</span>
        </button>
      </div>
      <div class="m-note">Обычно это занимает немного времени.</div>
    </div>
  </div>

  <script>
    // Тема из Telegram
    try{
      const tp = window?.Telegram?.WebApp?.themeParams || {};
      if (tp && (tp.bg_color || tp.secondary_bg_color || tp.text_color)){
        const root = document.documentElement;
        if (tp.bg_color)               root.style.setProperty('--m-bg',        '#'+tp.bg_color);
        if (tp.text_color)             root.style.setProperty('--m-text',      '#'+tp.text_color);
        if (tp.hint_color)             root.style.setProperty('--m-muted',     '#'+tp.hint_color);
        if (tp.secondary_bg_color)     root.style.setProperty('--m-card',      '#'+tp.secondary_bg_color);
        if (tp.section_separator_color)root.style.setProperty('--m-border',    '#'+tp.section_separator_color);
        if (tp.button_color)           root.style.setProperty('--m-primary',   '#'+tp.button_color);
      }
      if (window?.Telegram?.WebApp?.colorScheme === 'dark'){
        document.documentElement.classList.add('tg-dark');
      }
    }catch{}

    // Мини-хелпер открытия чата
    function openExternal(url){
      try{
        const tg = window?.Telegram?.WebApp;
        if (tg?.openTelegramLink){ tg.openTelegramLink(url); return; }
        if (tg?.openLink){ tg.openLink(url, { try_instant_view:false }); return; }
      }catch{}
      window.open(url, '_blank', 'noopener');
    }

    // Поддержка рендеринга Lucide для этого экрана (ждём, пока библиотека загрузится)
    (function ensureLucide(){
      if (window.lucide?.createIcons) { try { window.lucide.createIcons(); } catch {} return; }
      setTimeout(ensureLucide, 50);
    })();

    // ======== УМНЫЙ GATE ДЛЯ ТЕХРАБОТ (админы проходят) ========
    async function isAdminUser(cfg){
      // 1) локальный токен
      const localToken =
        (function(){ try{ return localStorage.getItem('admin_api_token') || '' }catch{ return '' } })() ||
        (window.__ADMIN_API_TOKEN__ || '');

      // 2) Telegram user id (если есть)
      let tgUserId = null;
      try { tgUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null; } catch {}

      // 3) Белый список из конфига
      try {
        if (Array.isArray(cfg?.adminIds) && tgUserId && cfg.adminIds.includes(String(tgUserId))) {
          return true;
        }
      } catch {}

      // 4) Аварийный обход для дев-режима: ?adminbypass=1
      try { const p = new URLSearchParams(location.search); if (p.get('adminbypass') === '1') return true; } catch {}

      // 5) Серверная проверка (если есть)
      try {
        const payload = {
          token: localToken || null,
          initData: (function(){ try{ return window.Telegram?.WebApp?.initData || '' }catch{ return '' } })(),
        };
        const r = await fetch('/.netlify/functions/can-access-admin', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          cache: 'no-store',
          body: JSON.stringify(payload),
        });
        if (r.ok) {
          const j = await r.json().catch(()=> ({}));
          if (j && (j.ok === true || j.allowed === true)) return true;
        }
      } catch {}

      // 6) Мягкое правило: если токен есть, а строгая проверка не включена — пускаем
      if (localToken && !cfg?.strictAdminCheck) return true;

      return false;
    }

    function showMaintenanceOverlay(cfg){
      window.__APP_MAINTENANCE__ = true;
      const node = document.getElementById('maintenanceScreen');
      node?.classList?.add('show');

      // Блокируем только приложение
      const app = document.getElementById('app');
      if (app){
        app.setAttribute('aria-hidden','true');
        try { app.inert = true; } catch {}
      }
      document.documentElement.classList.add('maintenance-lock');
      document.body.classList.add('maintenance-lock');

      // Кнопка «оператор»
      const opUrl = cfg?.opChat || 'https://t.me/evliseorder';
      const btn = document.getElementById('mOpBtn');
      if (btn) btn.addEventListener('click', function onClick(e){
        e.preventDefault();
        openExternal(opUrl);
      }, { passive: true });

      try { window.lucide?.createIcons?.(); } catch {}
    }

    function showAdminBypassBadge(){
      try{
        const b = document.createElement('div');
        b.textContent = 'MAINTENANCE (admin bypass)';
        b.style.cssText = 'position:fixed;left:8px;bottom:8px;z-index:999999;background:#000c;color:#fff;padding:6px 10px;border-radius:10px;font:12px/1.2 system-ui;backdrop-filter:blur(4px)';
        document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(b));
      }catch{}
    }

    (async () => {
      let cfg = null;
      try{
        const r = await fetch('/.netlify/functions/app-config', { cache:'no-store' });
        cfg = await r.json();
      }catch{ cfg = { maintenance:false }; }

      if (!cfg?.maintenance) return; // нет техработ — пропускаем всех

      const admin = await isAdminUser(cfg);
      if (admin) {
        showAdminBypassBadge(); // опционально
        return; // админов пропускаем
      }

      // не админ → показываем оверлей
      showMaintenanceOverlay(cfg);
    })();
    // ======== /УМНЫЙ GATE ========
  </script>
  <!-- ▲ Maintenance gate -->

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>EVLISE OUTLET — интернет-магазин одежды</title>
  <meta name="description" content="EVLISE OUTLET — стильная женская и мужская одежда со скидками. Новинки, акции и быстрый заказ прямо в Telegram WebApp." />
  <meta name="theme-color" content="#121111" />
  <meta name="application-name" content="EVLISE OUTLET" />
  <meta name="apple-mobile-web-app-title" content="EVLISE OUTLET" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Анти-кэш для HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Favicon / icons -->
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="EVLISE OUTLET" />
  <meta property="og:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta property="og:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta property="og:locale" content="ru_RU" />
  <meta property="og:image" content="assets/images/og-evlise.png" />
  <meta property="og:image:alt" content="EVLISE OUTLET — баннер магазина" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta name="twitter:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta name="twitter:image" content="assets/images/og-evlise.png" />

  <!-- ЕДИНЫЙ БИЛД-ШТАМП (обновляется versionize.mjs) -->
  <meta id="APP_BUILD" name="app-build" content="2025-10-30-21-17" />

  <!-- Лёгкая телеметрия (без влияния на кэш) -->
  <script>
  (function(){
    if (sessionStorage.__diag_sent__) return;
    sessionStorage.__diag_sent__ = '1';
    const payload = {
      ts: Date.now(),
      href: location.href,
      host: location.host,
      path: location.pathname,
      search: location.search,
      hash: location.hash,
      ref: document.referrer || '',
      ua: navigator.userAgent,
      tg: !!window.Telegram && !!Telegram.WebApp,
      tg_ver: (window.Telegram && Telegram.WebApp && Telegram.WebApp.version) || '',
      build: document.querySelector('meta[name="app-build"]')?.content || '',
    };
    fetch('/.netlify/functions/diag', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    }).catch(()=>{});
  })();
  </script>

  <script>
  /* Ранний и устойчивый к Telegram-хэшу детектор home-страницы */
  (function routeClassSync(){
    var de = document.documentElement;

    function isHomeHash(h){
      if (!h || h === '#') return true;
      if (/^#tgwebapp/i.test(h)) return true;
      if (!h.startsWith('#/')) return true;
      return (h === '#/' || h.startsWith('#/?'));
    }

    function apply(){
      var onHome = isHomeHash(location.hash);
      de.classList.toggle('route-home',  onHome);
      de.classList.toggle('route-other', !onHome);
    }

    apply();
    window.addEventListener('hashchange', apply, { passive:true });
    document.addEventListener('DOMContentLoaded', apply);
    window.addEventListener('load', apply);
  })();
  </script>

  <!-- Fonts / styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=2025-10-30-21-17" />

  <style>
    :root{
      --safe: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --stroke: rgba(15,23,42,.14);
      --tabbar-h: 92px;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --muted:#787676;

      /* spacer под верхние кнопки Telegram */
      --tg-topbar: 56px; /* при желании 52–60px */
    }

    /* показ секций только на главной */
    [data-home-only]{ display:block !important; }
    .route-other [data-home-only]{ display:none !important; }

    /* === Spacer под кнопки Telegram (глобально) === */
    #tgTopInset{ height:0; }
    .tg-webapp #tgTopInset{ height: calc(var(--safe-top) + var(--tg-topbar)); }

    /* статичный app-header больше не используется */
    .app-header{ display:none !important; }

    /* === Уведомления (новая система "точек") === */
    .badge-wrap{ position:relative } /* чтобы не сломать бейдж корзины */

    .section-search .search-wrap{ position:relative }
    .section-search .search{ width:100%; padding-right:44px }
    .search-photo{
      position:absolute; right:8px; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:10px;
      border:1px solid var(--stroke); background:#fff; display:inline-flex; align-items:center; justify-content:center; box-shadow:var(--shadow)
    }
    @media (prefers-color-scheme:dark){
      .search-photo{ background:#0b1220; color:#fff }
    }
    .search-photo i{ pointer-events:none }

    .ps-modal{ display:flex; flex-direction:column; gap:14px }
    .ps-hero{ display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--stroke); border-radius:14px; background:rgba(0,0,0,.02) }
    @media (prefers-color-scheme:dark){ .ps-hero{ background:rgba(255,255,255,.03) } }
    .ps-hero__ico{ width:40px; height:40px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--stroke); background:#fff; box-shadow:var(--shadow); flex:0 0 auto }
    @media (prefers-color-scheme:dark){ .ps-hero__ico{ background:#0b1220; color:#fff } }
    .ps-hero__text{ display:flex; flex-direction:column; line-height:1.24 }
    .ps-hero__title{ font-weight:700; font-size:16px }
    .ps-hero__hint{ color:var(--muted); font-size:13px }
    .ps-steps{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px }
    .ps-step{ display:flex; gap:10px; align-items:flex-start; padding:10px 12px; border:1px dashed var(--stroke); border-radius:12px }
    .ps-step-num{ flex:0 0 auto; width:22px; height:22px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--stroke); font-size:12px; background:#fff }
    @media (prefers-color-scheme:dark){ .ps-step-num{ background:#0b1220; color:#fff } }
    .ps-actions{ display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:4px }
    .ps-actions .btn-primary{ padding:10px 14px; border-radius:12px; display:inline-flex; align-items:center; gap:8px }
    .ps-actions .btn-ghost{ padding:10px 12px; border:1px solid var(--stroke); background:transparent; border-radius:12px }
  </style>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  (function(){
    var isTG = !!(window.Telegram && Telegram.WebApp);
    var ref = (document.referrer||'').toLowerCase();
    if (isTG || ref.includes('t.me') || ref.includes('telegram')) {
      document.documentElement.classList.add('tg-webapp');
    }
  })();
  </script>

  <!-- Lucide -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.454.0/dist/umd/lucide.min.js" defer></script>

  <!-- Канонический хост — всегда evliseoutlet.netlify.app -->
  <script>
  (function enforceCanonical(){
    var CANON = 'evliseoutlet.netlify.app';
    if (location.hostname !== CANON) {
      var target = 'https://' + CANON + location.pathname + location.search + location.hash;
      try { location.replace(target); } catch { location.href = target; }
    }
  })();
  </script>

  <!-- Бейдж версии (по ?showbuild=1) -->
  <script>
  (function showBuildBadge(){
    if (!location.search.includes('showbuild=1')) return;
    var build = document.getElementById('APP_BUILD')?.content || 'n/a';
    var d=document.createElement('div');
    d.style.cssText='position:fixed;right:8px;bottom:8px;z-index:99999;background:#0008;color:#fff;padding:6px 10px;border-radius:10px;font:12px/1.2 system-ui';
    d.textContent='BUILD ' + build + ' @ ' + location.hostname;
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(d));
  })();
  </script>
</head>

<body>
  <div id="app">
    <!-- Глобальный верхний отступ под кнопки Telegram -->
    <div id="tgTopInset" aria-hidden="true"></div>

    <!-- Фикс-хедер товара -->
    <div id="productFixHdr" class="product-fixhdr" aria-hidden="true">
      <button id="btnFixBack" class="fixbtn" aria-label="Назад"><i data-lucide="arrow-left"></i></button>
      <button id="btnFixFav" class="fixbtn" aria-label="В избранное" aria-pressed="false"><i data-lucide="heart"></i></button>
    </div>

    <!-- Поиск + фильтры (ТОЛЬКО НА ГЛАВНОЙ) -->
    <section class="section section-search" data-home-only>
      <div class="search-wrap">
        <i data-lucide="search" class="search-ico"></i>
        <input id="searchInput" class="search" placeholder="Поиск одежды…" />
        <button id="btnPhotoSearch" class="search-photo" aria-label="Поиск по фото"><i data-lucide="camera"></i></button>
      </div>
      <button id="openFilters" class="square-btn" aria-label="Открыть фильтры"><i data-lucide="sliders-horizontal"></i></button>
    </section>

    <!-- Категории (ТОЛЬКО НА ГЛАВНОЙ) -->
    <section class="section" data-home-only>
      <div class="chipbar" id="catChips" aria-label="Категории"></div>
    </section>

    <!-- Активные фильтры (ТОЛЬКО НА ГЛАВНОЙ) -->
    <section class="section" id="activeFilters" aria-live="polite" data-home-only></section>

    <!-- Контент -->
    <main id="view" class="view"></main>

    <!-- Модалка -->
    <div id="modal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true">
        <div class="modal-head">
          <div id="modalTitle"></div>
          <button id="modalClose" class="icon-btn" aria-label="Закрыть"><i data-lucide="x"></i></button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div id="modalActions" class="modal-actions"></div>
      </div>
    </div>

    <div id="toastWrap" class="toast-wrap"></div>

    <!-- Нижний таббар -->
    <nav class="tabbar" role="tablist" aria-label="Основная навигация">
      <div class="tabbar-inner">
        <a href="#/" data-tab="home" class="tab active" role="tab" aria-selected="true">
          <i data-lucide="home"></i><span>Главная</span>
        </a>
        <a href="#/favorites" data-tab="saved" class="tab" role="tab" aria-selected="false">
          <i data-lucide="heart"></i><span>Избранное</span>
        </a>
        <a href="#/cart" data-tab="cart" class="tab badge-wrap" role="tab" aria-selected="false">
          <i data-lucide="shopping-bag"></i><span>Корзина</span>
          <b id="cartBadge" class="badge" hidden></b>
        </a>
        <a href="#/account" data-tab="account" class="tab" role="tab" aria-selected="false">
          <i data-lucide="user-round"></i><span>Аккаунт</span>
        </a>
      </div>
    </nav>

    <!-- Кнопка «вверх» -->
    <button id="scrollTopBtn" class="icon-btn" aria-label="Наверх" hidden>
      <i data-lucide="chevrons-up"></i>
    </button>

    <!-- Шаблоны -->
    <template id="product-card">
      <a class="card" href="#">
        <div class="card-img">
          <img loading="lazy" alt="">
          <button class="fav" aria-label="В избранное" aria-pressed="false">
            <i data-lucide="heart"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="title"></div>
          <div class="subtitle"></div>
          <div class="price-row"><div class="price"></div></div>
        </div>
      </a>
    </template>

    <template id="filter-chip"><span class="chip chip-mini"></span></template>
  </div>

  <!-- ADMIN TOKEN INJECTION (только в Telegram-вью) -->
  <script>
  (function(){
    var ADMIN_TOKEN = 'UsA^5976JJbD4g6j*t^jkJMoMa%*Ho!j';
    var h=(document.referrer||'').toLowerCase(), ua=(navigator.userAgent||'').toLowerCase();
    var isTgRef = h.startsWith('https://t.me') || h.startsWith('https://web.telegram.org') || h.startsWith('https://telegram.org');
    var isTgUA  = ua.includes('telegram');
    var hasInitData = (function(){ try{ return typeof window.Telegram?.WebApp?.initData==='string' && Telegram.WebApp.initData.length>0 }catch{ return false } })();
    if ((isTgRef||isTgUA||hasInitData) && ADMIN_TOKEN){
      window.__ADMIN_API_TOKEN__=ADMIN_TOKEN;
      try{ localStorage.setItem('admin_api_token', String(ADMIN_TOKEN)); }catch{}
    }
    try{
      var p = new URLSearchParams(location.search);
      var q=p.get('admintoken');
      if(q){
        window.__ADMIN_API_TOKEN__=q;
        localStorage.setItem('admin_api_token', q);
        p.delete('admintoken');
        history.replaceState({},'',location.pathname+(p.toString()?('?'+p.toString()):'')+location.hash);
      }
    }catch{}
  })();
  </script>

  <!-- Поиск по фото (модалка) -->
  <script>
  (function(){
    var SUPPORT_TARGET='evliseorder';
    function tgOpen(url){
      try{ if(window.Telegram?.WebApp?.openTelegramLink){ Telegram.WebApp.openTelegramLink(url); return; } }catch{}
      window.open(url,'_blank','noopener,noreferrer');
    }
    function resolveTargetLink(){
      if(!SUPPORT_TARGET) return 'https://t.me/';
      if(/^https?:\/\//i.test(SUPPORT_TARGET)) return SUPPORT_TARGET;
      return 'https://t.me/'+SUPPORT_TARGET;
    }
    function openPhotoSearchModal(){
      var modal=document.getElementById('modal'), mb=document.getElementById('modalBody'), mt=document.getElementById('modalTitle'), ma=document.getElementById('modalActions');
      if(!modal||!mb||!mt||!ma) return;
      mt.textContent='Поиск по фото';
      mb.innerHTML=`<div class="ps-modal"><div class="ps-hero"><div class="ps-hero__ico"><i data-lucide="camera"></i></div>
      <div class="ps-hero__text"><div class="ps-hero__title">Найдём вещь по вашим фото</div><div class="ps-hero__hint">Пришлите 1–5 фото желаемой вещи — мы попробуем найти вещь и ответим в чате.</div></div></div>
      <ul class="ps-steps"><li class="ps-step"><div class="ps-step-num">1</div><div class="ps-step-text">Нажмите «Написать оператору».</div></li>
      <li class="ps-step"><div class="ps-step-num">2</div><div class="ps-step-text">Прикрепите фото вещи в открывшемся чате Telegram.</div></li>
      <li class="ps-step"><div class="ps-step-num">3</div><div class="ps-step-text">Мы подберём подходящие позиции.</div></li></ul></div>`;
      var link=resolveTargetLink();
      ma.innerHTML=`<div class="ps-actions"><button id="psCancel" class="btn-ghost">Отмена</button>
      <button id="psOpenChat" class="btn-primary"><i data-lucide="send"></i><span>Написать оператору</span></button></div>`;
      modal.classList.add('show'); try{ window.lucide?.createIcons?.(); }catch{}
      var close=()=>modal.classList.remove('show');
      document.getElementById('modalClose')?.addEventListener('click', close, {once:true});
      document.getElementById('psCancel')?.addEventListener('click', close, {once:true});
      document.getElementById('psOpenChat')?.addEventListener('click', ()=>{ tgOpen(link); close(); }, {once:true});
      var onKey=(e)=>{ if(e.key==='Escape'){ close(); window.removeEventListener('keydown', onKey);} }; window.addEventListener('keydown', onKey);
    }
    document.getElementById('btnPhotoSearch')?.addEventListener('click', (e)=>{ e.preventDefault(); openPhotoSearchModal(); });
    try{ window.lucide?.createIcons?.(); }catch{}
  })();
  </script>

  <!-- ВХОД: обычный модуль (версионируется versionize.mjs) -->
  <script type="module" src="src/main.js?v=2025-10-30-21-17"></script>
</body>
</html>
