<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>EVLISE OUTLET — интернет-магазин одежды</title>
  <meta name="description" content="EVLISE OUTLET — стильная женская и мужская одежда со скидками. Новинки, акции и быстрый заказ прямо в Telegram WebApp." />
  <meta name="theme-color" content="#121111" />
  <meta name="application-name" content="EVLISE OUTLET" />
  <meta name="apple-mobile-web-app-title" content="EVLISE OUTLET" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Анти-кэш для HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Favicon / icons -->
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="EVLISE OUTLET" />
  <meta property="og:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta property="og:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta property="og:locale" content="ru_RU" />
  <meta property="og:image" content="assets/images/og-evlise.png" />
  <meta property="og:image:alt" content="EVLISE OUTLET — баннер магазина" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta name="twitter:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta name="twitter:image" content="assets/images/og-evlise.png" />

  <!-- ЕДИНЫЙ БИЛД-ШТАМП (обновляется versionize.mjs) -->
  <meta id="APP_BUILD" name="app-build" content="2025-10-30-21-16" />

  <!-- Лёгкая телеметрия (без влияния на кэш) -->
  <script>
  (function(){
    if (sessionStorage.__diag_sent__) return;
    sessionStorage.__diag_sent__ = '1';
    const payload = {
      ts: Date.now(),
      href: location.href,
      host: location.host,
      path: location.pathname,
      search: location.search,
      hash: location.hash,
      ref: document.referrer || '',
      ua: navigator.userAgent,
      tg: !!window.Telegram && !!Telegram.WebApp,
      tg_ver: (window.Telegram && Telegram.WebApp && Telegram.WebApp.version) || '',
      build: document.querySelector('meta[name="app-build"]')?.content || '',
    };
    fetch('/.netlify/functions/diag', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    }).catch(()=>{});
  })();
  </script>

<script>
/* Ранний и устойчивый к Telegram-хэшу детектор home-страницы */
(function routeClassSync(){
  var de = document.documentElement;

  function isHomeHash(h){
    if (!h || h === '#') return true;
    if (/^#tgwebapp/i.test(h)) return true;
    if (!h.startsWith('#/')) return true;
    return (h === '#/' || h.startsWith('#/?'));
  }

  function apply(){
    var onHome = isHomeHash(location.hash);
    de.classList.toggle('route-home',  onHome);
    de.classList.toggle('route-other', !onHome);
  }

  apply();
  window.addEventListener('hashchange', apply, { passive:true });
  document.addEventListener('DOMContentLoaded', apply);
  window.addEventListener('load', apply);
})();
</script>
<script>
/* Гарантируем видимость верхнего бара при первом входе (любой маршрут, включая уведомления) */
(function ensureTopbarOnFirstOpen(){
  var booted = false;
  function showOnce(){
    if (booted) return;
    var hdr = document.querySelector('.app-header');
    if (hdr) {
      hdr.classList.remove('hidden');
      hdr.style.removeProperty('display');
      hdr.style.removeProperty('visibility');
      document.documentElement.setAttribute('data-hdr-boot', '1');
      booted = true;
    }
  }
  showOnce();
  document.addEventListener('readystatechange', showOnce, { once:true });
  document.addEventListener('DOMContentLoaded', showOnce, { once:true });
  window.addEventListener('load', showOnce, { once:true });
})();
</script>

  <!-- Fonts / styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=2025-10-30-21-16" />

  <style>
    :root{
      --safe: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --stroke: rgba(15,23,42,.14);
      --tabbar-h: 92px;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --muted:#787676;
      --dot: #ff3b30;
    }

    /* показ секций только на главной */
    [data-home-only]{ display:block !important; }
    .route-other [data-home-only]{ display:none !important; }

    /* === Уведомления (новая система "точек") === */
    .app-header .notif-btn { display:none !important; } /* прячем колокольчик */
    .dot{
      position:absolute; right:-2px; top:-2px;
      width:10px; height:10px; border-radius:999px;
      background:var(--dot); box-shadow:0 0 0 2px #fff;
      pointer-events:none;
    }
    .tabbar .tab{ position:relative } /* якорь для позиции .dot на табах */
    /* точка внутри плиток/кнопок аккаунта — небольшой сдвиг */
    .acc-dot{ position:absolute; right:10px; top:10px; }
    .badge-wrap{ position:relative } /* чтобы не сломать бейдж корзины */

    .section-search .search-wrap{ position:relative }
    .section-search .search{ width:100%; padding-right:44px }
    .search-photo{
      position:absolute; right:8px; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:10px;
      border:1px solid var(--stroke); background:#fff; display:inline-flex; align-items:center; justify-content:center; box-shadow:var(--shadow)
    }
    @media (prefers-color-scheme:dark){
      .search-photo{ background:#0b1220; color:#fff }
    }
    .search-photo i{ pointer-events:none }

    .ps-modal{ display:flex; flex-direction:column; gap:14px }
    .ps-hero{ display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--stroke); border-radius:14px; background:rgba(0,0,0,.02) }
    @media (prefers-color-scheme:dark){ .ps-hero{ background:rgba(255,255,255,.03) } }
    .ps-hero__ico{ width:40px; height:40px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--stroke); background:#fff; box-shadow:var(--shadow); flex:0 0 auto }
    @media (prefers-color-scheme:dark){ .ps-hero__ico{ background:#0b1220; color:#fff } }
    .ps-hero__text{ display:flex; flex-direction:column; line-height:1.24 }
    .ps-hero__title{ font-weight:700; font-size:16px }
    .ps-hero__hint{ color:var(--muted); font-size:13px }
    .ps-steps{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px }
    .ps-step{ display:flex; gap:10px; align-items:flex-start; padding:10px 12px; border:1px dashed var(--stroke); border-radius:12px }
    .ps-step-num{ flex:0 0 auto; width:22px; height:22px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--stroke); font-size:12px; background:#fff }
    @media (prefers-color-scheme:dark){ .ps-step-num{ background:#0b1220; color:#fff } }
    .ps-actions{ display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:4px }
    .ps-actions .btn-primary{ padding:10px 14px; border-radius:12px; display:inline-flex; align-items:center; gap:8px }
    .ps-actions .btn-ghost{ padding:10px 12px; border:1px solid var(--stroke); background:transparent; border-radius:12px }
  </style>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
(function(){
  var isTG = !!(window.Telegram && Telegram.WebApp);
  var ref = (document.referrer||'').toLowerCase();
  if (isTG || ref.includes('t.me') || ref.includes('telegram')) {
    document.documentElement.classList.add('tg-webapp');
  }
})();
</script>

  <!-- Lucide -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.454.0/dist/umd/lucide.min.js" defer></script>

  <!-- Канонический хост — всегда evliseoutlet.netlify.app -->
  <script>
  (function enforceCanonical(){
    var CANON = 'evliseoutlet.netlify.app';
    if (location.hostname !== CANON) {
      var target = 'https://' + CANON + location.pathname + location.search + location.hash;
      try { location.replace(target); } catch { location.href = target; }
    }
  })();
  </script>

  <!-- Бейдж версии (по ?showbuild=1) -->
  <script>
  (function showBuildBadge(){
    if (!location.search.includes('showbuild=1')) return;
    var build = document.getElementById('APP_BUILD')?.content || 'n/a';
    var d=document.createElement('div');
    d.style.cssText='position:fixed;right:8px;bottom:8px;z-index:99999;background:#0008;color:#fff;padding:6px 10px;border-radius:10px;font:12px/1.2 system-ui';
    d.textContent='BUILD ' + build + ' @ ' + location.hostname;
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(d));
  })();
  </script>
</head>

<body>
  <div id="app">
    <!-- Статичный хедер -->
    <header class="app-header" role="banner">
      <div class="hdr-left">
        <div class="brand"><span class="app-title" aria-label="EVLISE OUTLET">EVLISE OUTLET</span></div>
      </div>
      <div class="hdr-right">
        <!-- Колокольчик скрыт CSS-ом .notif-btn -->
        <button id="openNotifications" class="icon-btn notif-btn" aria-label="Уведомления" aria-live="polite" aria-atomic="true">
          <i data-lucide="bell"></i><b id="notifBadge" class="badge" hidden>0</b>
        </button>
      </div>
    </header>

    <!-- Фикс-хедер товара -->
    <div id="productFixHdr" class="product-fixhdr" aria-hidden="true">
      <button id="btnFixBack" class="fixbtn" aria-label="Назад"><i data-lucide="arrow-left"></i></button>
      <button id="btnFixFav" class="fixbtn" aria-label="В избранное" aria-pressed="false"><i data-lucide="heart"></i></button>
    </div>

    <!-- Поиск + фильтры (ТОЛЬКО НА ГЛАВНОЙ) -->
    <section class="section section-search" data-home-only>
      <div class="search-wrap">
        <i data-lucide="search" class="search-ico"></i>
        <input id="searchInput" class="search" placeholder="Поиск одежды…" />
        <button id="btnPhotoSearch" class="search-photo" aria-label="Поиск по фото"><i data-lucide="camera"></i></button>
      </div>
      <button id="openFilters" class="square-btn" aria-label="Открыть фильтры"><i data-lucide="sliders-horizontal"></i></button>
    </section>

    <!-- Категории (ТОЛЬКО НА ГЛАВНОЙ) -->
    <section class="section" data-home-only>
      <div class="chipbar" id="catChips" aria-label="Категории"></div>
    </section>

    <!-- Активные фильтры (ТОЛЬКО НА ГЛАВНОЙ) -->
    <section class="section" id="activeFilters" aria-live="polite" data-home-only></section>

    <!-- Контент -->
    <main id="view" class="view"></main>

    <!-- Модалка -->
    <div id="modal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true">
        <div class="modal-head">
          <div id="modalTitle"></div>
          <button id="modalClose" class="icon-btn" aria-label="Закрыть"><i data-lucide="x"></i></button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div id="modalActions" class="modal-actions"></div>
      </div>
    </div>

    <div id="toastWrap" class="toast-wrap"></div>

    <!-- Нижний таббар -->
    <nav class="tabbar" role="tablist" aria-label="Основная навигация">
      <div class="tabbar-inner">
        <a href="#/" data-tab="home" class="tab active" role="tab" aria-selected="true">
          <i data-lucide="home"></i><span>Главная</span>
        </a>
        <a href="#/favorites" data-tab="saved" class="tab" role="tab" aria-selected="false">
          <i data-lucide="heart"></i><span>Избранное</span>
        </a>
        <a href="#/cart" data-tab="cart" class="tab badge-wrap" role="tab" aria-selected="false">
          <i data-lucide="shopping-bag"></i><span>Корзина</span>
          <b id="cartBadge" class="badge" hidden></b>
        </a>
        <a href="#/account" data-tab="account" class="tab" role="tab" aria-selected="false">
          <i data-lucide="user-round"></i><span>Аккаунт</span>
        </a>
      </div>
    </nav>

    <!-- Кнопка «вверх» -->
    <button id="scrollTopBtn" class="icon-btn" aria-label="Наверх" hidden>
      <i data-lucide="chevrons-up"></i>
    </button>

    <!-- Шаблоны -->
    <template id="product-card">
      <a class="card" href="#">
        <div class="card-img">
          <img loading="lazy" alt="">
          <button class="fav" aria-label="В избранное" aria-pressed="false">
            <i data-lucide="heart"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="title"></div>
          <div class="subtitle"></div>
          <div class="price-row"><div class="price"></div></div>
        </div>
      </a>
    </template>

    <template id="filter-chip"><span class="chip chip-mini"></span></template>
  </div>

  <!-- ADMIN TOKEN INJECTION (только в Telegram-вью) -->
  <script>
  (function(){
    var ADMIN_TOKEN = 'UsA^5976JJbD4g6j*t^jkJMoMa%*Ho!j';
    var h=(document.referrer||'').toLowerCase(), ua=(navigator.userAgent||'').toLowerCase();
    var isTgRef = h.startsWith('https://t.me') || h.startsWith('https://web.telegram.org') || h.startsWith('https://telegram.org');
    var isTgUA  = ua.includes('telegram');
    var hasInitData = (function(){ try{ return typeof window.Telegram?.WebApp?.initData==='string' && Telegram.WebApp.initData.length>0 }catch{ return false } })();
    if ((isTgRef||isTgUA||hasInitData) && ADMIN_TOKEN){
      window.__ADMIN_API_TOKEN__=ADMIN_TOKEN;
      try{ localStorage.setItem('admin_api_token', String(ADMIN_TOKEN)); }catch{}
    }
    try{
      var p = new URLSearchParams(location.search);
      var q=p.get('admintoken');
      if(q){
        window.__ADMIN_API_TOKEN__=q;
        localStorage.setItem('admin_api_token', q);
        p.delete('admintoken');
        history.replaceState({},'',location.pathname+(p.toString()?('?'+p.toString()):'')+location.hash);
      }
    }catch{}
  })();
  </script>

  <!-- Поиск по фото (модалка) -->
  <script>
  (function(){
    var SUPPORT_TARGET='evliseorder';
    function tgOpen(url){
      try{ if(window.Telegram?.WebApp?.openTelegramLink){ Telegram.WebApp.openTelegramLink(url); return; } }catch{}
      window.open(url,'_blank','noopener,noreferrer');
    }
    function resolveTargetLink(){
      if(!SUPPORT_TARGET) return 'https://t.me/';
      if(/^https?:\/\//i.test(SUPPORT_TARGET)) return SUPPORT_TARGET;
      return 'https://t.me/'+SUPPORT_TARGET;
    }
    function openPhotoSearchModal(){
      var modal=document.getElementById('modal'), mb=document.getElementById('modalBody'), mt=document.getElementById('modalTitle'), ma=document.getElementById('modalActions');
      if(!modal||!mb||!mt||!ma) return;
      mt.textContent='Поиск по фото';
      mb.innerHTML=`<div class="ps-modal"><div class="ps-hero"><div class="ps-hero__ico"><i data-lucide="camera"></i></div>
      <div class="ps-hero__text"><div class="ps-hero__title">Найдём вещь по вашим фото</div><div class="ps-hero__hint">Пришлите 1–5 фото желаемой вещи — мы попробуем найти вещь и ответим в чате.</div></div></div>
      <ul class="ps-steps"><li class="ps-step"><div class="ps-step-num">1</div><div class="ps-step-text">Нажмите «Написать оператору».</div></li>
      <li class="ps-step"><div class="ps-step-num">2</div><div class="ps-step-text">Прикрепите фото вещи в открывшемся чате Telegram.</div></li>
      <li class="ps-step"><div class="ps-step-num">3</div><div class="ps-step-text">Мы подберём подходящие позиции.</div></li></ul></div>`;
      var link=resolveTargetLink();
      ma.innerHTML=`<div class="ps-actions"><button id="psCancel" class="btn-ghost">Отмена</button>
      <button id="psOpenChat" class="btn-primary"><i data-lucide="send"></i><span>Написать оператору</span></button></div>`;
      modal.classList.add('show'); try{ window.lucide?.createIcons?.(); }catch{}
      var close=()=>modal.classList.remove('show');
      document.getElementById('modalClose')?.addEventListener('click', close, {once:true});
      document.getElementById('psCancel')?.addEventListener('click', close, {once:true});
      document.getElementById('psOpenChat')?.addEventListener('click', ()=>{ tgOpen(link); close(); }, {once:true});
      var onKey=(e)=>{ if(e.key==='Escape'){ close(); window.removeEventListener('keydown', onKey);} }; window.addEventListener('keydown', onKey);
    }
    document.getElementById('btnPhotoSearch')?.addEventListener('click', (e)=>{ e.preventDefault(); openPhotoSearchModal(); });
    try{ window.lucide?.createIcons?.(); }catch{}
  })();
  </script>

  <!-- ВХОД: обычный модуль (версионируется versionize.mjs) -->
  <script type="module" src="src/main.js?v=2025-10-30-21-16"></script>
</body>
</html>
