<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>EVLISE OUTLET — интернет-магазин одежды</title>
  <meta name="description" content="EVLISE OUTLET — стильная женская и мужская одежда со скидками. Новинки, акции и быстрый заказ прямо в Telegram WebApp." />
  <meta name="theme-color" content="#121111" />
  <meta name="application-name" content="EVLISE OUTLET" />
  <meta name="apple-mobile-web-app-title" content="EVLISE OUTLET" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Анти-кэш для HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Favicon / icons -->
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="EVLISE OUTLET" />
  <meta property="og:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta property="og:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta property="og:locale" content="ru_RU" />
  <meta property="og:image" content="assets/images/og-evlise.png" />
  <meta property="og:image:alt" content="EVLISE OUTLET — баннер магазина" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="EVLISE OUTLET — интернет-магазин одежды" />
  <meta name="twitter:description" content="Стильные вещи по Outlet-ценам. Смотрите каталог и заказывайте в пару кликов." />
  <meta name="twitter:image" content="assets/images/og-evlise.png" />

  <!-- Fonts / styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Lucide (пинованная версия) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.454.0/dist/umd/lucide.min.js" defer></script>
</head>

<body>
  <div id="app">
    <!-- Статичный хедер -->
    <header class="app-header" role="banner">
      <div class="hdr-left">
        <div class="brand">
          <span class="app-title" aria-label="EVLISE OUTLET">EVLISE OUTLET</span>
        </div>
      </div>
      <div class="hdr-right">
        <button
          id="openNotifications"
          class="icon-btn notif-btn"
          aria-label="Уведомления"
          aria-live="polite"
          aria-atomic="true">
          <i data-lucide="bell"></i>
          <b id="notifBadge" class="badge" hidden>0</b>
        </button>
      </div>
    </header>

    <!-- Фикс-хедер товара -->
    <div id="productFixHdr" class="product-fixhdr" aria-hidden="true">
      <button id="btnFixBack" class="fixbtn" aria-label="Назад">
        <i data-lucide="arrow-left"></i>
      </button>
      <button id="btnFixFav" class="fixbtn" aria-label="В избранное" aria-pressed="false">
        <i data-lucide="heart"></i>
      </button>
    </div>

    <!-- Поиск + фильтры -->
    <section class="section section-search">
      <div class="search-wrap">
        <i data-lucide="search" class="search-ico"></i>
        <input id="searchInput" class="search" placeholder="Поиск одежды…" />
      </div>
      <button id="openFilters" class="square-btn" aria-label="Открыть фильтры">
        <i data-lucide="sliders-horizontal"></i>
      </button>
    </section>

    <!-- Категории -->
    <section class="section">
      <div class="chipbar" id="catChips" aria-label="Категории"></div>
    </section>

    <!-- Активные фильтры -->
    <section class="section" id="activeFilters" aria-live="polite"></section>

    <!-- Контент -->
    <main id="view" class="view"></main>

    <!-- Модалка -->
    <div id="modal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true">
        <div class="modal-head">
          <div id="modalTitle"></div>
          <button id="modalClose" class="icon-btn" aria-label="Закрыть"><i data-lucide="x"></i></button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div id="modalActions" class="modal-actions"></div>
      </div>
    </div>

    <div id="toastWrap" class="toast-wrap"></div>

    <!-- Нижний таббар -->
    <nav class="tabbar" role="tablist" aria-label="Основная навигация">
      <div class="tabbar-inner">
        <a href="#/" data-tab="home" class="tab active" role="tab" aria-selected="true">
          <i data-lucide="home"></i><span>Главная</span>
        </a>
        <a href="#/favorites" data-tab="saved" class="tab" role="tab" aria-selected="false">
          <i data-lucide="heart"></i><span>Избранное</span>
        </a>
        <a href="#/cart" data-tab="cart" class="tab badge-wrap" role="tab" aria-selected="false">
          <i data-lucide="shopping-bag"></i><span>Корзина</span>
          <b id="cartBadge" class="badge" hidden></b>
        </a>
        <a href="#/account" data-tab="account" class="tab" role="tab" aria-selected="false">
          <i data-lucide="user-round"></i><span>Аккаунт</span>
        </a>
      </div>
    </nav>

    <!-- Кнопка «вверх» -->
    <button id="scrollTopBtn" class="icon-btn" aria-label="Наверх" hidden>
      <i data-lucide="chevrons-up"></i>
    </button>

    <!-- Шаблоны -->
    <template id="product-card">
      <a class="card" href="#">
        <div class="card-img">
          <img loading="lazy" alt="">
          <button class="fav" aria-label="В избранное" aria-pressed="false">
            <i data-lucide="heart"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="title"></div>
          <div class="subtitle"></div>
          <div class="price-row">
            <div class="price"></div>
          </div>
        </div>
      </a>
    </template>

    <template id="filter-chip">
      <span class="chip chip-mini"></span>
    </template>
  </div>

  <!-- === ADMIN TOKEN INJECTION (works in Telegram WebApp only) === -->
  <script>
    (function () {
      // !!! ЗАМЕНИ на точное значение ADMIN_API_TOKEN из Netlify !!!
      var ADMIN_TOKEN = 'UsA^5976JJbD4g6j*t^jkJMoMa%*Ho!j';

      var h = (document.referrer || '').toLowerCase();
      var ua = (navigator.userAgent || '').toLowerCase();
      var isTgRef = h.startsWith('https://t.me') ||
                    h.startsWith('https://web.telegram.org') ||
                    h.startsWith('https://telegram.org');
      var isTgUA  = ua.indexOf('telegram') !== -1;

      var hasInitData = (function () {
        try { return typeof window.Telegram?.WebApp?.initData === 'string' && window.Telegram.WebApp.initData.length > 0; }
        catch { return false; }
      })();

      if ((isTgRef || isTgUA || hasInitData) && ADMIN_TOKEN) {
        window.__ADMIN_API_TOKEN__ = ADMIN_TOKEN;
        try { localStorage.setItem('admin_api_token', String(ADMIN_TOKEN)); } catch {}
      }

      try {
        var p = new URLSearchParams(location.search);
        var q = p.get('admintoken');
        if (q) {
          window.__ADMIN_API_TOKEN__ = q;
          localStorage.setItem('admin_api_token', q);
          p.delete('admintoken');
          history.replaceState({}, '', location.pathname + (p.toString() ? '?' + p.toString() : '') + location.hash);
        }
      } catch {}
    })();
  </script>

  <!-- Главный модуль -->
  <script type="module" src="src/main.js"></script>

  <!-- Иконки после монтирования (запасной вызов) -->
  <script> try { window.lucide?.createIcons?.(); } catch {} </script>

  <!-- Локальный JS: кнопка «вверх» (автономно) -->
  <script>
    (function(){
      const btn = document.getElementById('scrollTopBtn');
      if(!btn) return;

      function onScroll(){
        const sc = Math.max(document.documentElement.scrollTop || 0, window.scrollY || 0);
        btn.hidden = sc < 300;
      }
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();

      btn.addEventListener('click', ()=> window.scrollTo({ top:0, behavior:'smooth' }));
      try{ window.lucide?.createIcons?.(); }catch{}
    })();
  </script>
</body>
</html>
