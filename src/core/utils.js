// src/core/utils.js

// ==============================
// Telegram WebApp helpers
// ==============================

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç Telegram WebApp (–µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram)
export const tg = window?.Telegram?.WebApp || null;

/**
 * –õ—ë–≥–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–¥ Telegram-—Ö—Ä–æ–º: –≤—ã–∑—ã–≤–∞–µ–º ready/expand –∏
 * —Å—Ç–∞—Ä–∞–µ–º—Å—è –Ω–µ –ø–∞–¥–∞—Ç—å, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
 */
export function initTelegramChrome() {
  if (!tg) return;
  try { tg.ready(); } catch (_) {}
  try { tg.expand(); } catch (_) {}
  try { tg.setHeaderColor('#0a0a0a'); } catch (_) {}
  try { tg.setBackgroundColor('#0a0a0a'); } catch (_) {}
}

// ==============================
// DOM helpers
// ==============================
export const el   = (sel) => document.querySelector(sel);
export const els  = (sel) => Array.from(document.querySelectorAll(sel));
export const byId = (id)  => document.getElementById(id);

// ==============================
// –§–æ—Ä–º–∞—Ç—ã/–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
// ==============================

export const priceFmt = (n) =>
  new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'UZS',
    maximumFractionDigits: 0,
  }).format(Number(n) || 0);

/* =======================================================================
   –¶–≤–µ—Ç–∞
   - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è (—Ä–µ–≥–∏—Å—Ç—Ä, —ë/–µ, "—Ü–≤–µ—Ç", –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã/–¥–µ—Ñ–∏—Å—ã)
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–µ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
   - –°–æ—Å—Ç–∞–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ ("—á–µ—Ä–Ω–æ-–±–µ–ª—ã–π", "black/white") ‚Üí –≥—Ä–∞–¥–∏–µ–Ω—Ç
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —É–∂–µ –≤–∞–ª–∏–¥–Ω—ã–π CSS-—Ü–≤–µ—Ç/–≥—Ä–∞–¥–∏–µ–Ω—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
   - –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π
   ======================================================================= */

/** –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ—Ö–æ–∂–µ –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –≥–æ—Ç–æ–≤—ã–π CSS-—Ü–≤–µ—Ç/–≥—Ä–∞–¥–∏–µ–Ω—Ç */
function looksLikeCssColor(s = '') {
  const v = String(s).trim().toLowerCase();
  return (
    v.startsWith('#') ||
    v.startsWith('rgb(') || v.startsWith('rgba(') ||
    v.startsWith('hsl(') || v.startsWith('hsla(') ||
    v.startsWith('var(') ||
    v.startsWith('linear-gradient(') ||
    v.startsWith('repeating-linear-gradient(') ||
    v.startsWith('radial-gradient(') ||
    v.startsWith('conic-gradient(')
  );
}

/** –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ —Ü–≤–µ—Ç–∞: —Ç—Ä–∏–º, lower, —ë‚Üí–µ, —É–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ "—Ü–≤–µ—Ç" –∏ –ø—Ä. */
export function normalizeColorName(name = '') {
  let s = String(name || '')
    .trim()
    .toLowerCase()
    .replace(/—ë/g, '–µ')
    .replace(/\s*—Ü–≤–µ—Ç(–∞|–æ–º|—É|—ã)?\b/g, '') // —É–±–∏—Ä–∞–µ–º "—Ü–≤–µ—Ç", "—Ü–≤–µ—Ç–∞" –∏ —Ç.–ø.
    .replace(/\s*-\s*/g, '-')             // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–µ—Ñ–∏—Å—ã
    .replace(/\s*\/\s*/g, '/')            // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–ª–µ—à–∏
    .replace(/[,|]/g, '/')                // –∑–∞–ø—è—Ç–∞—è/–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    .replace(/\s+/g, ' ')                 // —Å—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    .trim();

  // –ë–∞–∑–æ–≤—ã–µ –∞–ª–∏–∞—Å—ã –Ω–∞ –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
  const aliases = {
    // —á—ë—Ä–Ω—ã–π
    '—á–µ—Ä–Ω—ã–π': '—á–µ—Ä–Ω—ã–π', '—á–µ—Ä–Ω': '—á–µ—Ä–Ω—ã–π', 'black': '—á–µ—Ä–Ω—ã–π',
    // –±–µ–ª—ã–π
    '–±–µ–ª—ã–π': '–±–µ–ª—ã–π', 'white': '–±–µ–ª—ã–π',
    // —Å–µ—Ä—ã–π
    '—Å–µ—Ä—ã–π': '—Å–µ—Ä—ã–π', '—Å–µ—Ä': '—Å–µ—Ä—ã–π', 'gray': '—Å–µ—Ä—ã–π', 'grey': '—Å–µ—Ä—ã–π',
    // —Å–∏–Ω–∏–π
    '—Å–∏–Ω–∏–π': '—Å–∏–Ω–∏–π', 'blue': '—Å–∏–Ω–∏–π',
    // üî¥ –∫—Ä–∞—Å–Ω—ã–π
    '–∫—Ä–∞—Å–Ω—ã–π': '–∫—Ä–∞—Å–Ω—ã–π', '–∫—Ä–∞—Å': '–∫—Ä–∞—Å–Ω—ã–π', 'red': '–∫—Ä–∞—Å–Ω—ã–π',
    // –∑–µ–ª—ë–Ω—ã–π
    '–∑–µ–ª–µ–Ω—ã–π': '–∑–µ–ª–µ–Ω—ã–π', '–∑–µ–ª—ë–Ω—ã–π': '–∑–µ–ª–µ–Ω—ã–π', 'green': '–∑–µ–ª–µ–Ω—ã–π',
    // –∂—ë–ª—Ç—ã–π
    '–∂–µ–ª—Ç—ã–π': '–∂–µ–ª—Ç—ã–π', '–∂—ë–ª—Ç—ã–π': '–∂–µ–ª—Ç—ã–π', 'yellow': '–∂–µ–ª—Ç—ã–π',
    // –±–µ–∂–µ–≤—ã–π
    '–±–µ–∂–µ–≤—ã–π': '–±–µ–∂–µ–≤—ã–π', 'beige': '–±–µ–∂–µ–≤—ã–π',
    // —Ä–æ–∑–æ–≤—ã–π
    '—Ä–æ–∑–æ–≤—ã–π': '—Ä–æ–∑–æ–≤—ã–π', 'pink': '—Ä–æ–∑–æ–≤—ã–π',
    // –±–æ—Ä–¥–æ–≤—ã–π / –º–∞—Ä—Å–∞–ª–∞
    '–±–æ—Ä–¥–æ–≤—ã–π': '–±–æ—Ä–¥–æ–≤—ã–π', 'maroon': '–±–æ—Ä–¥–æ–≤—ã–π', 'wine': '–±–æ—Ä–¥–æ–≤—ã–π',
    // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π': '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', 'purple': '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', 'violet': '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π',
    // –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
    '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π': '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π', 'brown': '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π',
    // —Å/–±–µ–∑ ¬´—Ü–≤–µ—Ç¬ª
    '—á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç': '—á–µ—Ä–Ω—ã–π',
    '–±–µ–ª—ã–π —Ü–≤–µ—Ç': '–±–µ–ª—ã–π',
    '—Å–µ—Ä—ã–π —Ü–≤–µ—Ç': '—Å–µ—Ä—ã–π',
    '–∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç': '–∫—Ä–∞—Å–Ω—ã–π',
  };

  if (aliases[s]) return aliases[s];

  // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —Å–æ—Å—Ç–∞–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –¥–µ—Ñ–∏—Å–æ–º/—Å–ª–µ—à–µ–º ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á–∞—Å—Ç–∏
  // –ü—Ä–∏–º–µ—Ä: "—á–µ—Ä–Ω—ã–π/–±–µ–ª—ã–π", "black-white", "—á–µ—Ä–Ω–æ –±–µ–ª—ã–π"
  const separators = /[-/ ]/;
  const parts = s.split(separators).filter(Boolean);
  if (parts.length >= 2) {
    const norm = parts
      .map(p => aliases[p] || p)
      .filter(Boolean)
      .slice(0, 3); // –º–∞–∫—Å–∏–º—É–º 3 —Ü–≤–µ—Ç–∞ —É—á–∏—Ç—ã–≤–∞–µ–º
    if (norm.length >= 2) {
      return norm.join('-');
    }
  }

  return s;
}

/** –ü–∞–ª–∏—Ç—Ä–∞ –±–∞–∑–æ–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤ */
export const COLOR_MAP = {
  '—á–µ—Ä–Ω—ã–π':     '#111111',
  '–±–µ–ª—ã–π':      '#ffffff',
  '—Å–µ—Ä—ã–π':      '#a3a1a2',
  '—Å–∏–Ω–∏–π':      '#1d4ed8',
  '–∑–µ–ª–µ–Ω—ã–π':    '#10b981',
  '–∂–µ–ª—Ç—ã–π':     '#f59e0b',
  '–±–µ–∂–µ–≤—ã–π':    '#d2b48c',
  '—Ä–æ–∑–æ–≤—ã–π':    '#ec4899',
  '–±–æ—Ä–¥–æ–≤—ã–π':   '#7f1d1d',
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π': '#7c3aed',
  '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π': '#8b5a2b',
  '–∫—Ä–∞—Å–Ω—ã–π':    '#ef4444', // üî¥ –∫—Ä–∞—Å–Ω—ã–π

  // –ß–∞—Å—Ç—ã–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
  '—á–µ—Ä–Ω–æ-–±–µ–ª—ã–π':   'linear-gradient(45deg, #000 0 50%, #fff 50% 100%)',
  '—á–µ—Ä–Ω—ã–π-–±–µ–ª—ã–π':  'linear-gradient(45deg, #000 0 50%, #fff 50% 100%)',
  '—á–µ—Ä–Ω—ã–π-—á–µ—Ä–Ω—ã–π': '#111111',
};

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç CSS-—Ü–≤–µ—Ç –¥–ª—è —Å–≤–æ—Ç—á–∞.
 * - –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –≤–∞–ª–∏–¥–Ω—ã–π CSS (hex/rgb/hsl/gradient/var) ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
 * - –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –∑–Ω–∞–∫–æ–º–æ–µ –∏–º—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º hex/–≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ COLOR_MAP
 * - –ï—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã 2‚Äì3 —Ü–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ "-" –∏–ª–∏ "/" ‚Äî —Å—Ç—Ä–æ–∏–º –≥—Ä–∞–¥–∏–µ–Ω—Ç 45deg
 * - –ò–Ω–∞—á–µ ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π
 */
export function colorToHex(name) {
  if (!name) return '#e5e7eb';

  const raw = String(name).trim();
  if (looksLikeCssColor(raw)) return raw;

  const key = normalizeColorName(raw);

  // 1) —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  if (COLOR_MAP[key]) return COLOR_MAP[key];

  // 2) —Å–æ—Å—Ç–∞–≤–Ω–æ–π —Ü–≤–µ—Ç –≤–∏–¥–∞ "—á–µ—Ä–Ω—ã–π-–±–µ–ª—ã–π-—Å–µ—Ä—ã–π" ‚Üí –≥—Ä–∞–¥–∏–µ–Ω—Ç
  const parts = key.split(/[-/]/).map(s => s.trim()).filter(Boolean);
  if (parts.length >= 2) {
    const colors = parts
      .map(p => COLOR_MAP[p])
      .filter(Boolean);

    if (colors.length >= 2) {
      // –°—Ç—Ä–æ–∏–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ 2‚Äì3 —Ü–≤–µ—Ç–æ–≤
      const step = 100 / colors.length;
      const stops = colors
        .map((c, i) => `${c} ${Math.round(i * step)}% ${Math.round((i + 1) * step)}%`)
        .join(', ');
      return `linear-gradient(45deg, ${stops})`;
    }
  }

  // 3) –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ ‚Äî –æ—Ç–¥–∞—ë–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π (—á—Ç–æ–±—ã —Å–≤–æ—Ç—á –±—ã–ª –≤–∏–¥–µ–Ω)
  return '#e5e7eb';
}
